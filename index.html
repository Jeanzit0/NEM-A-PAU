<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEM A PAU - Multiplayer Público</title>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
  body { margin: 0; background: #000; color: #fff; font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
  #players { position: absolute; top: 20px; right: 20px; border: 1px solid #fff; padding: 15px; font-size: 0.9em; min-width: 150px; z-index: 10; background: rgba(0,0,0,0.8); }
  
  /* CHAT */
  #chat-container { position: absolute; bottom: 20px; left: 20px; width: 320px; height: 300px; border: 1px solid #fff; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 100; }
  #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.8rem; text-align: left; }
  #chat-input { background: #111; border: none; border-top: 1px solid #fff; color: #fff; padding: 12px; width: 100%; box-sizing: border-box; outline: none; }

  #app { width: 100%; display: flex; justify-content: center; }
  .center { text-align: center; max-width: 650px; width: 90%; }
  .logo { font-family: 'Impact', sans-serif; font-size: 3.5rem; letter-spacing: 5px; border: 4px solid #fff; padding: 10px 20px; display: inline-block; margin-bottom: 25px; text-transform: uppercase; }
  
  input { background: #000; color: #fff; border: 1px solid #fff; padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; text-align: center; font-size: 1.2rem; }
  button { background: #fff; color: #000; border: 1px solid #fff; padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; width: 100%; transition: 0.2s; }
  button:hover { background: #ccc; }
  .pergunta-texto { font-size: 1.4rem; margin: 20px 0; min-height: 80px; }
</style>
</head>
<body>

<div id="players"></div>
<div id="app"></div>

<div id="chat-container">
  <div style="padding:5px; font-size:0.7rem; border-bottom:1px solid #333; text-align:center;">COMANDO PÚBLICO: /join [nome_da_sala]</div>
  <div id="chat-messages"></div>
  <input type="text" id="chat-input" placeholder="Mensagem ou /join..." onkeydown="if(event.key==='Enter') tratarInput()">
</div>

<script>
/* ================= CONFIGURAÇÃO FIREBASE ================= */
// Importante: Substitua pelos seus dados do console Firebase
const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  databaseURL: "SUA_DATABASE_URL",
  projectId: "SEU_PROJECT_ID",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* ================= ESTADO DO JOGO ================= */
let state = {
  tela: "inicial",
  jogadores: [],
  meuNome: "",
  souHost: false,
  salaId: null,
  jogadorDaVez: null,
  pergunta: null,
  valorAtual: null,
  ultimoJogador: null,
  pontosParaPerder: 10
};

/* ================= LÓGICA DE SALA PÚBLICA ================= */

function tratarInput() {
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg) return;

  if (msg.startsWith("/")) {
    const partes = msg.split(" ");
    const cmd = partes[0].toLowerCase();

    // COMANDO PÚBLICO (SEM SENHA)
    if (cmd === "/join") {
      const novaSala = partes[1];
      if (!novaSala) return alert("Uso: /join nome_da_sala");
      conectarSala(novaSala);
    } 
    // COMANDOS ADMIN (COM SENHA)
    else {
      const senha = prompt("Senha de Administrador:");
      if (senha === "jean24gs") {
        executarComando(msg);
      } else {
        alert("Senha incorreta!");
      }
    }
  } else {
    enviarMensagemChat(msg);
  }
  input.value = "";
}

function conectarSala(id) {
  // Limpa conexões anteriores se houver
  if (state.salaId) {
    db.ref(`salas/${state.salaId}/estado`).off();
    db.ref(`salas/${state.salaId}/chat`).off();
  }

  state.salaId = id;
  exibirNoChat("SISTEMA", `Entrando na sala: <strong>${id}</strong>...`);

  // 1. Escutar Estado da Sala (Sincronização de Jogo)
  db.ref(`salas/${id}/estado`).on('value', (snapshot) => {
    const onlineState = snapshot.val();
    if (onlineState) {
      state.tela = onlineState.tela;
      state.jogadores = onlineState.jogadores || [];
      state.jogadorDaVez = onlineState.jogadorDaVez;
      state.pergunta = onlineState.pergunta;
      state.valorAtual = onlineState.valorAtual;
      state.ultimoJogador = onlineState.ultimoJogador;
      render();
    }
  });

  // 2. Escutar Chat da Sala
  db.ref(`salas/${id}/chat`).on('child_added', (snap) => {
    const m = snap.val();
    exibirNoChat(m.autor, m.texto);
  });

  // 3. Registrar-se como jogador ativo na sala
  db.ref(`salas/${id}/estado`).once('value', (snap) => {
    let data = snap.val() || { tela: "espera", jogadores: [] };
    const jaExiste = data.jogadores.find(j => j.nome === state.meuNome);
    
    if (!jaExiste) {
      data.jogadores.push({ nome: state.meuNome, pontos: 0, humano: true });
      if (data.jogadores.length === 1) state.souHost = true;
      db.ref(`salas/${id}/estado`).set(data);
    }
  });
}

function enviarMensagemChat(texto) {
  if (!state.salaId) return alert("Você precisa entrar em uma sala primeiro! Use /join");
  db.ref(`salas/${state.salaId}/chat`).push({
    autor: state.meuNome,
    texto: texto
  });
}

function exibirNoChat(autor, texto) {
  const box = document.getElementById("chat-messages");
  const div = document.createElement("div");
  div.style.marginBottom = "5px";
  div.innerHTML = `<strong>${autor}</strong>: ${texto}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}

/* TUTORIAL: CRIAR COMANDOS
   case "/meucomando":
      lógica aqui...
      salvarEstadoNoFirebase(); // Importante para todos verem a mudança
      break;
*/
function executarComando(msg) {
  const cmd = msg.split(" ")[0].toLowerCase();
  if (cmd === "/endgame") {
    state.tela = "ranking";
    salvarEstadoNoFirebase();
  } else if (cmd === "/takehost") {
    state.souHost = true;
    exibirNoChat("SISTEMA", "Você agora é o HOST desta sessão.");
    render();
  }
}

function salvarEstadoNoFirebase() {
  if (state.salaId) {
    db.ref(`salas/${state.salaId}/estado`).set(state);
  }
}

/* ================= RENDERIZAÇÃO ================= */

function render() {
  // Segurança: se o nome sumiu, volta pro início
  if (state.tela !== "inicial" && !state.meuNome) { location.reload(); return; }

  const app = document.getElementById("app");
  const playersDiv = document.getElementById("players");
  const chatCont = document.getElementById("chat-container");
  
  app.innerHTML = "";
  const box = document.createElement("div");
  box.className = "center";
  app.appendChild(box);

  if (state.tela === "inicial") {
    playersDiv.style.display = "none";
    chatCont.style.display = "none";
    box.innerHTML = `
      <div class="logo">NEM A PAU</div>
      <input id="nomeInput" placeholder="SEU NOME">
      <button onclick="entrarNoSistema()">ENTRAR</button>
    `;
  } else {
    playersDiv.style.display = "block";
    chatCont.style.display = "flex";
    playersDiv.innerHTML = "<strong>PLACAR</strong><br>" + state.jogadores.map(j => `<div>${j.nome}: ${j.pontos}</div>`).join("");
  }

  if (state.tela === "espera") {
    box.innerHTML = `
      <h2>SALA: ${state.salaId.toUpperCase()}</h2>
      <div style="margin-bottom:20px">${state.jogadores.map(j=>`<div>- ${j.nome}</div>`).join("")}</div>
      ${state.souHost ? `<button onclick="iniciarPartida()">INICIAR JOGO</button>` : `<p><small>Aguardando o Host iniciar...</small></p>`}
    `;
  }

  if (state.tela === "jogo") {
    const jVez = state.jogadorDaVez;
    box.innerHTML = `
      <div>VEZ DE: <strong>${jVez.nome.toUpperCase()}</strong></div>
      <div class="pergunta-texto">${state.pergunta.texto} (${state.pergunta.unidade})</div>
      ${state.valorAtual ? `<p>Último palpite: <strong>${state.valorAtual}</strong></p>` : ""}
      
      ${jVez.nome === state.meuNome ? `
        <input id="valorChute" type="number" placeholder="Valor maior que ${state.valorAtual || 0}">
        <button onclick="enviarChute()">CHUTAR</button>
        ${state.valorAtual ? `<button onclick="duvidarFirebase()" style="background:none; color:red; border-color:red; margin-top:5px;">NEM A PAU!</button>` : ""}
      ` : `<p>Aguardando o outro jogador...</p>`}
    `;
  }
  
  // Telas de resultado e ranking seguiriam salvando no Firebase...
}

/* ================= AÇÕES ================= */

function entrarNoSistema() {
  const nome = document.getElementById("nomeInput").value.trim();
  if (!nome) return alert("Digite seu nome!");
  state.meuNome = nome;
  state.tela = "espera";
  conectarSala("geral"); // Conecta na sala padrão inicial
}

function iniciarPartida() {
  state.tela = "jogo";
  state.pergunta = { texto: "Qual a população estimada do Brasil?", unidade: "pessoas", resposta: 214300000 };
  state.jogadorDaVez = state.jogadores[0];
  state.valorAtual = null;
  salvarEstadoNoFirebase();
}

function enviarChute() {
  const v = Number(document.getElementById("valorChute").value);
  if (state.valorAtual && v <= state.valorAtual) return alert("O chute deve ser maior!");
  
  state.valorAtual = v;
  state.ultimoJogador = state.jogadorDaVez;
  
  // Passa a vez para o próximo na lista
  const idx = state.jogadores.findIndex(j => j.nome === state.jogadorDaVez.nome);
  state.jogadorDaVez = state.jogadores[(idx + 1) % state.jogadores.length];
  
  salvarEstadoNoFirebase();
}

function duvidarFirebase() {
  // Lógica de dúvida simplificada para exemplo
  const correta = state.pergunta.resposta;
  if (state.valorAtual > correta) {
    state.ultimoJogador.pontos++;
  } else {
    const idx = state.jogadores.findIndex(j => j.nome === state.meuNome);
    state.jogadores[idx].pontos++;
  }
  // Reinicia rodada
  state.valorAtual = null;
  salvarEstadoNoFirebase();
}

render();
</script>
</body>
</html>