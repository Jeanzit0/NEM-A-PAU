<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEM A PAU - Ultimate Edition</title>

<style>
body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #fff;
    font-family: 'Courier New', Courier, monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
}

#players {
    position: absolute;
    top: 20px;
    right: 20px;
    border: 1px solid #fff;
    padding: 15px;
    text-align: right;
    font-size: 0.9em;
    min-width: 150px;
    display: none;
}

#chat {
    position: absolute;
    bottom: 0;
    left: 0;
    width: 100%;
    background: #000;
    border-top: 1px solid #fff;
    padding: 10px;
}

#chatMessages {
    max-height: 150px;
    overflow-y: auto;
    font-size: 0.85em;
    margin-bottom: 5px;
}

#chat input {
    width: 100%;
    background: #000;
    color: #fff;
    border: 1px solid #fff;
    padding: 8px;
}

#app {
    width: 100%;
    display: flex;
    justify-content: center;
}

.center {
    text-align: center;
    max-width: 650px;
    width: 90%;
}

.logo {
    font-family: 'Impact', sans-serif;
    font-size: 3.5rem;
    letter-spacing: 5px;
    border: 4px solid #fff;
    padding: 10px 20px;
    display: inline-block;
    margin-bottom: 30px;
}

input, button {
    background: #000;
    color: #fff;
    border: 1px solid #fff;
    padding: 12px;
    margin: 10px 0;
    width: 100%;
}

button {
    background: #fff;
    color: #000;
    cursor: pointer;
}
</style>
</head>

<body>

<div id="players"></div>
<div id="app">CONECTANDO...</div>

<div id="chat" style="display:none">
    <div id="chatMessages"></div>
    <input id="chatInput" placeholder="Digite uma mensagem ou comando (/endgame)">
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
/* =====================
   CONFIG FIREBASE
===================== */
firebase.initializeApp({
    apiKey: "AIzaSyBLfN4uLs6L1_XnSSdpIbhrPKBSreAtK_8",
    authDomain: "nemapau-47956.firebaseapp.com",
    databaseURL: "https://nemapau-47956-default-rtdb.firebaseio.com/",
    projectId: "nemapau-47956"
});

const db = firebase.database();
const gameRef = db.ref("game_state");
const playersRef = db.ref("players");
const chatRef = db.ref("chat");

/* =====================
   VARIÁVEIS
===================== */
let state = {};
let myId = null;
let logado = false;

/* =====================
   CHAT GLOBAL
===================== */
chatRef.limitToLast(50).on("child_added", snap => {
    const m = snap.val();
    const div = document.createElement("div");
    div.innerHTML = `<strong>${m.nome}:</strong> ${m.msg}`;
    document.getElementById("chatMessages").appendChild(div);
});

/* =====================
   ENVIO DE CHAT / TERMINAL
===================== */
document.getElementById("chatInput").addEventListener("keydown", e => {
    if (e.key !== "Enter") return;

    const texto = e.target.value.trim();
    e.target.value = "";

    if (!texto) return;

    if (texto.startsWith("/")) {
        executarComando(texto);
    } else {
        chatRef.push({ nome: state.jogadores[myId].nome, msg: texto });
    }
});

/* =====================
   TERMINAL DE COMANDOS
   =====================
   PARA CRIAR NOVOS COMANDOS:
   1. Use /nomecomando
   2. Crie um case abaixo
   3. A senha SEMPRE será solicitada antes
===================== */
function executarComando(cmd) {
    const senha = prompt("Senha do comando:");
    if (senha !== "jean24gs") return alert("Senha incorreta");

    switch(cmd) {

        case "/endgame":
            gameRef.update({ tela: "ranking" });
            chatRef.push({ nome: "SISTEMA", msg: "Jogo encerrado pelo terminal." });
        break;

        case "/takehost":
            gameRef.update({ host: myId });
            chatRef.push({ nome: "SISTEMA", msg: `${state.jogadores[myId].nome} agora é o HOST.` });
        break;

        default:
            alert("Comando desconhecido");
    }
}

/* =====================
   ESTADO DO JOGO
===================== */
gameRef.on("value", snap => {
    state = snap.val() || { tela: "inicial", jogadores: {} };

    // Jogador sem nome volta ao início
    if (logado && (!state.jogadores[myId] || !state.jogadores[myId].nome)) {
        logado = false;
    }

    render();
});

/* =====================
   RENDER
===================== */
function render() {
    const app = document.getElementById("app");
    const chat = document.getElementById("chat");

    if (!logado) {
        chat.style.display = "none";
        app.innerHTML = `
        <div class="center">
            <div class="logo">NEM A PAU</div>
            <input id="nome" placeholder="SEU NOME">
            <input id="bots" type="number" min="0" max="5" value="0">
            <button onclick="entrar()">ENTRAR</button>
        </div>`;
        return;
    }

    chat.style.display = "block";
    app.innerHTML = `<div class="center"><h2>${state.tela.toUpperCase()}</h2></div>`;
}

/* =====================
   ENTRAR
===================== */
async function entrar() {
    const nome = document.getElementById("nome").value.trim();
    if (!nome) return alert("Nome obrigatório");

    const pRef = playersRef.push();
    myId = pRef.key;
    await pRef.set({ id: myId, nome, pontos: 0 });

    logado = true;

    if (!state.host) {
        gameRef.set({ tela: "espera", jogadores: { [myId]: { id: myId, nome, pontos: 0 } }, host: myId });
    }
}
</script>

</body>
</html>
