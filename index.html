<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEM A PATO - Ultimate Online</title>
<link rel="icon" type="image/png" href="icone.png">
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

<style>
  body { margin: 0; padding: 0; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed;  color: #fff;  font-family: 'Courier New', monospace; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
  #players { position: absolute; top: 20px; right: 20px; border: 1px solid #fff; padding: 15px; text-align: right; font-size: 0.9em; min-width: 150px; z-index: 10; background: rgba(0,0,0,0.8); }
  #chat-container { position: absolute; bottom: 20px; left: 20px; width: 320px; height: 300px; border: 1px solid #fff; background: rgba(0,0,0,0.9); display: none; flex-direction: column; z-index: 100; }
  #chat-messages { flex-grow: 1; overflow-y: auto; padding: 10px; font-size: 0.85rem; text-align: left; }
  #chat-input { background: #111; border: none; border-top: 1px solid #fff; color: #fff; padding: 12px; width: 100%; box-sizing: border-box; outline: none; }
  #app { width: 100%; display: flex; justify-content: center; }
  .center { text-align: center; max-width: 650px; width: 90%; }
  .logo { font-family: 'Impact', sans-serif; font-size: 3.5rem; letter-spacing: 5px; border: 4px solid #fff; padding: 10px 20px; display: inline-block; margin-bottom: 25px; }
  input { background: #000; color: #fff; border: 1px solid #fff; padding: 12px; margin: 10px 0; width: 100%; box-sizing: border-box; text-align: center; font-size: 1.2rem; }
  button { background: #fff; color: #000; border: 1px solid #fff; padding: 12px; cursor: pointer; font-weight: bold; text-transform: uppercase; width: 100%; transition: 0.2s; }
  button:hover { background: #ccc; }
  .pergunta-texto { font-size: 1.8rem; font-weight: bold; margin-bottom: 5px; }
  .unidade-texto { font-size: 1.1rem; color: yellow; margin-bottom: 20px; text-transform: uppercase; }
  
  /* Modal de Troca de Nome */
  #overlay-nome { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; display: none; justify-content: center; align-items: center; }
  
  #cor-pincel {
  width: 40px;
  height: 40px;
  border: none;
  cursor: pointer;
}
</style>
</head>
<body>

<!-- TELA DE ABERTURA COM V√çDEO -->
<div id="tela-abertura" style="
  position:fixed;
  inset:0;
  background:#000;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:5000;
">

  <video id="video-abertura" autoplay playsinline style="width:100%; height:100%; object-fit:cover;">
    <source src="video_tela_abertura.mp4" type="video/mp4">
  </video>

</div>

<div id="overlay-nome">
  <div class="center" style="border: 2px solid #fff; padding: 30px; background: #000;">
    <h3>NOME J√Å EM USO NESSA SALA</h3>
    <p>Escolha um nome diferente para entrar:</p>
    <input id="novoNomeInp" placeholder="Novo Nome">
    <button onclick="trocarNomeEEntrar()">ALTERAR NOME</button>
    <button onclick="voltarEspera()" style="background:none; color: #fff; margin-top: 10px;">CANCELAR</button>
  </div>
</div>

<div id="players"></div>
<div id="app"></div>

<div id="chat-container">
  <div style="padding: 5px; background: #222; font-size: 0.7rem; text-align: center; border-bottom: 1px solid #444;">DIGITE /join NOME_DA_SALA</div>
  <div id="chat-messages"></div>
  <input type="text" id="chat-input" placeholder="Mensagem ou comando..." onkeydown="if(event.key==='Enter') tratarChat()">
</div>

<script>

/*Conex√£o do user, para evitar jogadores fantasmas*/
const minhaConexaoId = Date.now() + "_" + Math.random().toString(36).substr(2, 9);

/* ================= M√öSICA ================= */
document.addEventListener("click", function iniciarMusica() {
  const musica = document.getElementById("bg-music");
  const btn = document.getElementById("music-btn");

  musica.volume = 0.5;
  musica.play();
  btn.textContent = "üéµ M√öSICA";

  document.removeEventListener("click", iniciarMusica);
});

function toggleMusic() {
  const musica = document.getElementById("bg-music");
  const btn = document.getElementById("music-btn");

  if (musica.paused) {
    musica.volume = 0.5;
    musica.play();
    btn.textContent = "üéµ M√öSICA";
  } else {
    musica.pause();
    btn.textContent = "üéµüö´ M√öSICA";
  }
}

/* ================= CONFIGURA√á√ÉO FIREBASE ================= */
const firebaseConfig = {
    apiKey: "AIzaSyBLfN4uLs6L1_XnSSdpIbhrPKBSreAtK_8",
    authDomain: "nemapau-47956.firebaseapp.com",
    databaseURL: "https://nemapau-47956-default-rtdb.firebaseio.com/",
    projectId: "nemapau-47956",
    storageBucket: "nemapau-47956.firebasestorage.app",
    messagingSenderId: "575679805707",
    appId: "1:575679805707:web:768cf1108ede446f710a0e"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const bancoPerguntasOriginal = [
  { texto: "Qual a altura do homem mais alto do mundo?", unidade: "Metros (m)", resposta: 2.74 },
  { texto: "Qual a altura do homem mais alto na atualidade?", unidade: "Metros (m)", resposta: 2.51 },
  { texto: "Qual a altura da mulher mais alta do mundo?", unidade: "Metros (m)", resposta: 2.48 },
  { texto: "Qual a altura da mulher mais alta na atualidade?", unidade: "Metros (m)", resposta: 2.34 },
  { texto: "Qual a altura do homem mais baixo do mundo?", unidade: "Cent√≠metros (cm)", resposta: 54.6 },
  { texto: "Qual a altura da mulher mais baixa do mundo?", unidade: "Cent√≠metros (cm)", resposta: 58 },
  { texto: "Qual a altura dos g√™meos id√™nticos mais baixos do mundo?", unidade: "Cent√≠metros (cm)", resposta: 86 },
  { texto: "Qual o peso do homem mais pesado do mundo?", unidade: "Quilogramas (kg)", resposta: 635 },
  { texto: "Qual o peso da mulher mais pesada do mundo?", unidade: "Quilogramas (kg)", resposta: 545 },
  { texto: "Qual o comprimento do maior cabelo do mundo?", unidade: "Cent√≠metros (cm)", resposta: 562.7 },
  { texto: "Qual o comprimento da maior l√≠ngua do mundo?", unidade: "Cent√≠metros (cm)", resposta: 10 },
  { texto: "Qual a menor cintura j√° registrada?", unidade: "Cent√≠metros (cm)", resposta: 38 },
  { texto: "Qual o maior n√∫mero de dedos em uma pessoa?", unidade: "Quantidade (unidades)", resposta: 34 },
  { texto: "Qual o comprimento da maior unha do mundo?", unidade: "Metros (m)", resposta: 7.51 },
  { texto: "Qual o comprimento do maior pelo de orelha j√° medido?", unidade: "Cent√≠metros (cm)", resposta: 13.2 },
  { texto: "Qual o comprimento do maior nariz medido em uma pessoa?", unidade: "Cent√≠metros (cm)", resposta: 8.8 },
  { texto: "Qual o comprimento da maior boca j√° registrada?", unidade: "Cent√≠metros (cm)", resposta: 17 },
  { texto: "Qual a altura da maior barba no mundo na atualidade?", unidade: "Metros (m)", resposta: 2.36 },
  { texto: "Qual a circunfer√™ncia dos maiores peitos naturais j√° medidos?", unidade: "Cent√≠metros (cm)", resposta: 177.8 },
  { texto: "Qual o maior peso ao nascer j√° registrado de um beb√™?", unidade: "Quilogramas (kg)", resposta: 7.04 },
  { texto: "Qual o maior n√∫mero de filhos de um casal na hist√≥ria?", unidade: "Quantidade (unidades)", resposta: 69 },
  { texto: "Qual o maior n√∫mero de filhos que um homem j√° teve?", unidade: "Quantidade (unidades)", resposta: 888 },
  { texto: "Qual o maior n√∫mero de filhos que uma mulher j√° teve?", unidade: "Quantidade (unidades)", resposta: 69 },
  { texto: "Qual a idade da mulher mais velha a ter um filho com registro?", unidade: "Anos (anos)", resposta: 66 },
  { texto: "Qual a √°rea do maior parque tem√°tico do mundo?", unidade: "Metros quadrados (m¬≤)", resposta: 121729441 },
  { texto: "Qual a maior queda vertical em uma montanha-russa do mundo?", unidade: "Metros (m)", resposta: 127.4 },
  { texto: "Qual o comprimento da montanha-russa mais longa do mundo?", unidade: "Metros (m)", resposta: 1273.1 },
  { texto: "Qual a velocidade da montanha-russa mais r√°pida do mundo?", unidade: "Quil√¥metros por hora (km/h)", resposta: 107 },
  { texto: "Qual a altura do maior tobo√°gua do mundo?", unidade: "Metros (m)", resposta: 49.9 },
  { texto: "Quantos animais abriga o maior zool√≥gico do mundo?", unidade: "Quantidade (animais)", resposta: 12600 },
  { texto: "Qual a capacidade de p√∫blico do maior teatro do mundo?", unidade: "Quantidade (pessoas)", resposta: 10000 },
  { texto: "Qual a √°rea do maior teatro do mundo em termos de espa√ßo?", unidade: "Metros quadrados (m¬≤)", resposta: 100000 },
  { texto: "Qual a altura da maior est√°tua do mundo?", unidade: "Metros (m)", resposta: 182 },
  { texto: "Qual a altura da maior escultura do mundo?", unidade: "Metros (m)", resposta: 55 },
  { texto: "Qual o volume da maior pir√¢mide do mundo?", unidade: "Metros c√∫bicos (m¬≥)", resposta: 4450000 },
  { texto: "Qual a altura da pir√¢mide mais alta do mundo?", unidade: "Metros (m)", resposta: 137.16 },
  { texto: "Qual a √°rea do maior parque urbano do mundo?", unidade: "Metros quadrados (m¬≤)", resposta: 1200000 },
  { texto: "Qual o comprimento da subida mais √≠ngreme do mundo?", unidade: "Metros (m)", resposta: 350 },
  { texto: "Qual o comprimento da maior rua do mundo?", unidade: "Quil√¥metros (km)", resposta: 61.6 },
  { texto: "Qual o comprimento da menor rua do mundo?", unidade: "Metros (m)", resposta: 2.06 },
  { texto: "Qual a profundidade do Po√ßo Superprofundo de Kola?", unidade: "Metros (m)", resposta: 12262 },
  { texto: "Qual a altura do edif√≠cio mais alto do mundo?", unidade: "Metros (m)", resposta: 818 },
  { texto: "Qual a altura da torre mais alta do mundo?", unidade: "Metros (m)", resposta: 634 },
  { texto: "Quantos quartos tem o maior hotel do mundo?", unidade: "Quantidade (quartos)", resposta: 6276 },
  { texto: "Qual a √°rea do maior pal√°cio do mundo?", unidade: "Metros quadrados (m¬≤)", resposta: 350000 },
  { texto: "Qual a capacidade do maior est√°dio coberto do mundo?", unidade: "Quantidade (pessoas)", resposta: 90000 },
  { texto: "Qual o comprimento da maior piscina do mundo?", unidade: "Metros (m)", resposta: 1013 },
  { texto: "Qual a √°rea da maior piscina coberta do mundo?", unidade: "Metros quadrados (m¬≤)", resposta: 20000 },
  { texto: "Qual a profundidade da piscina mais funda do mundo?", unidade: "Metros (m)", resposta: 33 },
  { texto: "Quantas lojas tem o maior shopping do mundo?", unidade: "Quantidade (lojas)", resposta: 2350 },
  { texto: "Qual a √°rea do maior shopping do mundo?", unidade: "Metros quadrados (m¬≤)", resposta: 350000 },
  { texto: "Qual o peso do objeto constru√≠do pelo homem mais pesado do mundo?", unidade: "Toneladas (t)", resposta: 656000 },
  { texto: "Qual a pot√™ncia instalada da maior hidrel√©trica do mundo?", unidade: "Megawatts (MW)", resposta: 22500 },
  { texto: "Qual o comprimento do maior t√∫nel ferrovi√°rio do mundo?", unidade: "Quil√¥metros (km)", resposta: 57 },
  { texto: "Qual a √°rea do computador mais r√°pido do mundo (medida usada)?", unidade: "Metros quadrados (m¬≤)", resposta: 372000 },
  { texto: "Qual a frequ√™ncia recorde de overclock j√° registrada?", unidade: "Megahertz (MHz)", resposta: 8461.51 },
  { texto: "Quantos assinantes tinha o maior provedor de internet do mundo?", unidade: "Milh√µes de assinantes", resposta: 45 },
  { texto: "Qual a velocidade recorde de conex√£o √† internet transmitida para cinemas em Gb/s?", unidade: "Gigabits por segundo (Gb/s)", resposta: 10 },
  { texto: "Qual o peso do celular mais leve do mundo?", unidade: "Gramas (g)", resposta: 40 },
  { texto: "Qual a velocidade m√°xima alcan√ßada por um rob√¥ com pernas?", unidade: "Quil√¥metros por hora (km/h)", resposta: 28.97 },
  { texto: "Qual o recorde mundial de campo magn√©tico gerado n√£o-destrutivamente?", unidade: "Teslas (T)", resposta: 100.75 },
  { texto: "Qual a dist√¢ncia do recorde de teletransporte de f√≥tons?", unidade: "Quil√¥metros (km)", resposta: 97 },
  { texto: "Qual o valor arrecadado pelo produto de entretenimento mais vendido em um dia?", unidade: "D√≥lares (US$)", resposta: 1000000000 },
  { texto: "Qual o or√ßamento do filme mais barato j√° distribu√≠do?", unidade: "D√≥lares (US$)", resposta: 7000 },
  { texto: "Qual o or√ßamento do filme mais caro j√° produzido por Hollywood?", unidade: "D√≥lares (US$)", resposta: 356000000 },
  { texto: "Qual a dura√ß√£o do filme mais longo j√° produzido (em minutos)?", unidade: "Minutos (min)", resposta: 5220 },
  { texto: "Qual a dura√ß√£o do filme mais longo produzido por Hollywood (em minutos)?", unidade: "Minutos (min)", resposta: 243 },
  { texto: "Qual a dura√ß√£o do v√≠deo mais longo no YouTube (em horas)?", unidade: "Horas (h)", resposta: 571 },
  { texto: "Qual o maior n√∫mero de indica√ß√µes ao Oscar j√° recebidas por uma pessoa?", unidade: "Quantidade (indica√ß√µes)", resposta: 59 },
  { texto: "Quantos Oscars uma pessoa mais ganhou na hist√≥ria?", unidade: "Quantidade (estatuetas)", resposta: 26 },
  { texto: "Qual o maior n√∫mero de indica√ß√µes ao Oscar por um ator/atriz?", unidade: "Quantidade (indica√ß√µes)", resposta: 17 },
  { texto: "Qual o maior n√∫mero de Oscars ganhos por um ator/atriz?", unidade: "Quantidade (estatuetas)", resposta: 4 },
  { texto: "Qual a idade do ator/atriz mais velho a ganhar um Oscar?", unidade: "Anos (anos)", resposta: 82 },
  { texto: "Qual a idade do actor/atriz mais jovem a ganhar um Oscar?", unidade: "Anos (anos)", resposta: 10 },
  { texto: "Qual o maior p√∫blico registrado em um evento de games?", unidade: "Quantidade (pessoas)", resposta: 869543 },
  { texto: "Quantas unidades vendeu Call of Duty: Modern Warfare 3 no primeiro dia?", unidade: "Milh√µes de unidades", resposta: 6.5 },
  { texto: "Quantas c√≥pias vendeu o jogo mais vendido da hist√≥ria?", unidade: "Milh√µes de c√≥pias", resposta: 495 },
  { texto: "Qual a maior cole√ß√£o de consoles ainda em funcionamento?", unidade: "Quantidade (itens)", resposta: 483 },
  { texto: "Qual a maior pontua√ß√£o feminina no Guitar Hero III?", unidade: "Quantidade (pontos)", resposta: 789349 },
  { texto: "Qual o maior n√∫mero de pontua√ß√µes perfeitas em Wii Sports Bowling?", unidade: "Quantidade (vezes)", resposta: 2850 },
  { texto: "Quantas c√≥pias a B√≠blia vendeu (estimativa m√≠nima)?", unidade: "Bilh√µes de c√≥pias", resposta: 4 },
  { texto: "Em quantas l√≠nguas a B√≠blia foi traduzida?", unidade: "Quantidade (l√≠nguas)", resposta: 2400 },
  { texto: "Qual o peso do livro mais pesado do mundo?", unidade: "Quilogramas (kg)", resposta: 6200 },
  { texto: "Qual o maior p√∫blico do carnaval de Salvador por ano?", unidade: "Milh√µes de pessoas", resposta: 2 },
  { texto: "Qual o p√∫blico do Galo da Madrugada em festa de rua?", unidade: "Milh√µes de pessoas", resposta: 1.7 },
  { texto: "Qual o maior p√∫blico anual do Coachella Valley Music and Arts Festival?", unidade: "Pessoas por ano", resposta: 225000 },
  { texto: "Qual o p√∫blico do maior festival geek do mundo (South by Southwest)?", unidade: "Pessoas por ano", resposta: 50000 }
];

let state = {
  tela: "inicial",
  jogadores: [],
  meuNome: "",
  souHost: false,
  salaId: null,
  jogadorDaVez: null,
  pergunta: null,
  valorAtual: null,
  ultimoJogador: null,
  meuAvatar: null
};

const TEMPO_RESULTADO_DUVIDA = 10000; // 10000 = 10 segundos

function atualizarBackground() {

  if (state.tela === "inicial") {
    document.body.style.backgroundImage = "url('38oitava.jpg')";
  }

  else if (state.tela === "escolha-sala") {
    document.body.style.backgroundImage = "url('38oitava.jpg')";
  }

  else if (state.tela === "espera") {
    document.body.style.backgroundImage = "url('NEMAPATO.png')";
  }

  else if (state.tela === "jogo") {
    document.body.style.backgroundImage = "url('PERGUNTASNEMAPATO.png')";
  }

  else if (state.tela === "ranking") {
    document.body.style.backgroundImage = "url('RANKINGNEMAPATO.png')";
  }
}


/* ================= L√ìGICA DE SALAS E NOMES ================= */

function tratarChat() {
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg) return;

  if (msg.startsWith("/")) {
    const partes = msg.split(" ");
    const cmd = partes[0].toLowerCase();

    if (cmd === "/join") {
      const novaSala = partes[1];
      if (!novaSala) return alert("Uso: /join nome_da_sala");
      conectarASala(novaSala);
    } else {
      const senha = prompt("Senha Admin:");
      if (senha === "jean24gs") executarComandoAdmin(msg);
      else alert("Senha incorreta!");
    }
  } else {
    enviarMensagemChat(msg);
  }
  input.value = "";
}

function conectarASala(id) {
  const salaRef = db.ref(`salas/${id.toLowerCase()}/estado`);
  
  salaRef.once('value', (snap) => {
    const data = snap.val();
    // Verifica se o nome j√° existe na sala
    if (data && data.jogadores && data.jogadores.some(j => 
                                      j.nome.toLowerCase() === state.meuNome.toLowerCase() &&
                                      j.id !== minhaConexaoId)
        ) {
      document.getElementById("overlay-nome").style.display = "flex";
      state.salaAlvo = id.toLowerCase(); // Guarda para tentar novamente ap√≥s trocar nome
      return;
    }
    realizarConexao(id);
  });
}

function realizarConexao(id) {
  if (state.salaId) {
    db.ref(`salas/${state.salaId}/estado`).off();
    db.ref(`salas/${state.salaId}/chat`).off();
  }

  state.salaId = id.toLowerCase();
  const estadoRef = db.ref(`salas/${state.salaId}/estado`);

  // üî• Listener principal
  estadoRef.on('value', (snap) => {
    const onlineState = snap.val();
    if (onlineState) {
      state.tela = onlineState.tela;
      state.jogadores = onlineState.jogadores || [];
      state.jogadorDaVez = onlineState.jogadorDaVez;
      state.respostaOficial = onlineState.respostaOficial;
      state.jogadorUm = onlineState.jogadorUm;
      state.jogadorDois = onlineState.jogadorDois;
      state.jogadorUmPontuou = onlineState.jogadorUmPontuou;
      state.pergunta = onlineState.pergunta;
      state.valorAtual = onlineState.valorAtual;
      state.ultimoJogador = onlineState.ultimoJogador;

      state.souHost = (
        state.jogadores.length > 0 &&
        state.jogadores[0].id === minhaConexaoId
      );

      render();
    }
  });

  db.ref(`salas/${state.salaId}/chat`).on('child_added', (snap) => {
    const m = snap.val();
    exibirNoChat(m.autor, m.texto);
  });

  estadoRef.once('value', (snap) => {
    let currentData = snap.val() || { tela: "espera", jogadores: [] };

    // Remove duplicado por ID
    currentData.jogadores = (currentData.jogadores || []).filter(
      j => j.id !== minhaConexaoId
    );

    // Adiciona jogador
    currentData.jogadores.push({
      id: minhaConexaoId,
      nome: state.meuNome,
      pontos: 0,
      avatar: state.meuAvatar || null
    });

    // üî• SALVA NO FIREBASE
    estadoRef.set(currentData);

    // üî• onDisconnect correto (remove por √≠ndice atual)
    const index = currentData.jogadores.findIndex(j => j.id === minhaConexaoId);
    db.ref(`salas/${state.salaId}/estado/jogadores/${index}`)
      .onDisconnect()
      .remove();
  });

  document.getElementById("overlay-nome").style.display = "none";
  exibirNoChat("SISTEMA", `Conectado √† sala: ${state.salaId}`);
}

function trocarNomeEEntrar() {
  const novo = document.getElementById("novoNomeInp").value.trim();
  if (!novo) return;
  state.meuNome = novo;
  realizarConexao(state.salaAlvo);
}

function voltarEspera() {
  document.getElementById("overlay-nome").style.display = "none";
  state.tela = "escolha-sala";
  render();
}

/* ================= COMANDOS ADMIN ================= */

function executarComandoAdmin(msg) {
  const cmd = msg.split(" ")[0].toLowerCase();
  
  if (cmd === "/clear") {
    // Apaga o n√≥ 'salas' inteiro do Firebase
    db.ref('salas').remove()
      .then(() => alert("Banco de dados resetado com sucesso!"))
      .catch(e => alert("Erro ao resetar: " + e.message));
  }
  
  if (cmd === "/endgame") salvarEstadoGlobal({ tela: "ranking" });
  
  if (cmd === "/takehost") {
    const index = state.jogadores.findIndex(j => j.nome === state.meuNome);
    if (index !== -1) {
      const me = state.jogadores.splice(index, 1)[0];
      state.jogadores.unshift(me);
      salvarEstadoGlobal({ jogadores: state.jogadores });
    }
  }
}

/* ================= RENDERIZA√á√ÉO ================= */

function render() {
  atualizarBackground();

  const app = document.getElementById("app");
  const playersDiv = document.getElementById("players");
  const chatCont = document.getElementById("chat-container");
  
  app.innerHTML = "";
  const box = document.createElement("div");
  box.className = "center";
  app.appendChild(box);

  if (state.tela === "inicial") {
    playersDiv.style.display = "none";
    chatCont.style.display = "none";
    box.innerHTML = `<div class="logo">NEM A PATO</div><input id="nInp" placeholder="SEU NOME">

    <div style="margin-top:15px;">
      <label style="display:block; margin-bottom:8px;">SEU AVATAR</label>

      <div style="display:flex; gap:10px; align-items:center; justify-content:center;">
        
        <label style="
          background:#fff;
          color:#000;
          padding:10px 14px;
          font-weight:bold;
          text-transform:uppercase;
          cursor:pointer;
          border:1px solid #fff;
          min-width:140px;
          text-align:center;
        ">
          UPLOAD
          <input type="file" id="avatar-upload" accept="image/*" style="display:none;" onchange="uploadAvatar(event)">
        </label>

        <button onclick="abrirDesenho()" style="min-width:140px;">
          DESENHAR
        </button>

      </div>
    </div>
    <br>
    <button onclick="registrar()">ENTRAR</button>`;
    return;
  }

  if (state.tela === "escolha-sala") {
    chatCont.style.display = "flex";
    box.innerHTML = `<h2>SALA DE ESPERA</h2>
                     <p style="font-size: 1.2rem; color: #00ff00; margin: 30px 0;">Digite <strong>/join (nome_da_sala)</strong> para entrar em um jogo</p>
                     <p><small>O chat est√° no canto inferior esquerdo.</small></p>`;
    return;
  }

  playersDiv.style.display = "block";
  chatCont.style.display = "flex";
  playersDiv.innerHTML = `
    <strong>SALA: ${state.salaId.toUpperCase()}</strong>
    <br><hr>
  ` + 
  state.jogadores.map(j => `
    <div style="display:flex; align-items:center; gap:8px;">
      ${j.avatar ? `<img src="${j.avatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover;">` : ""}
      <span>${j.nome}: ${j.pontos}</span>
    </div>
  `).join("") + `
    <hr style="margin:10px 0;">
    <button onclick="sairDaSala()" style="background:#800; color:#fff; border-color:#800;">
      SAIR DA PARTIDA
    </button>
  `; 

  if (state.tela === "espera") {
    box.innerHTML = `<h2>SALA: ${state.salaId.toUpperCase()}</h2>` + 
      state.jogadores.map(j => `<div>‚Ä¢ ${j.nome}</div>`).join("") +
      (state.souHost ? `<button onclick="iniciarJogo()" style="margin-top:20px">INICIAR JOGO</button>` : `<p><small>Aguardando o Host iniciar...</small></p>`);
  }

  if (state.tela === "jogo") {
    const jVez = state.jogadorDaVez;
    box.innerHTML = `
      <div style="margin-bottom:30px; color:#00ff00;">VEZ DE: <strong style="color:#fff;">${jVez.nome.toUpperCase()}</strong></div>
      <div class="pergunta-texto">${state.pergunta.texto}</div>
      <div class="unidade-texto">UM: ${state.pergunta.unidade}</div>
      
      ${state.valorAtual ? `<p>Palpite atual: <strong style="font-size:1.5rem;">${state.valorAtual}</strong></p>` : "<p style='color:#00ff00'>In√≠cio da rodada!</p>"}
      
      <div style="margin-top:20px">
        ${jVez.nome === state.meuNome ? `
          <input id="chInp" type="number" placeholder="Maior que ${state.valorAtual || 0}">
          <button onclick="enviarPalpite()">CHUTAR</button>
          ${state.valorAtual ? `<button onclick="duvidar()" style="background:none; color:red; border-color:red; margin-top:10px;">NEM A PATO!</button>` : ""}
        ` : `<p>Aguardando ${jVez.nome} jogar...</p>`}
      </div>`;
  }

if (state.tela === "resultado-duvida") {

  const jogadorUm = state.jogadorUm;
  const jogadorDois = state.jogadorDois;

  box.innerHTML = `
    <div class="pergunta-texto">${state.pergunta.texto}</div>
    <div class="unidade-texto">UM: ${state.pergunta.unidade}</div>

    <p style="font-size:1.5rem; margin-top:15px;">
      RESPOSTA OFICIAL: <strong>${state.respostaOficial}</strong>
    </p>

    <hr style="margin:25px 0; border:1px solid #fff;">

    ${
      state.jogadorUmPontuou
      ?
      `
      <p style="color:red; font-size:1.3rem;">
        O jogador ${jogadorUm.nome}, <strong>marcou</strong> pontos nesta rodada.
      </p>
      <p style="color:yellow; font-size:1.3rem;">
        O jogador ${jogadorDois.nome}, <strong>n√£o marcou</strong> pontos nesta rodada.
      </p>
      `
      :
      `
      <p style="color:yellow; font-size:1.3rem;">
        O jogador ${jogadorUm.nome}, <strong>n√£o marcou</strong> pontos nesta rodada.
      </p>
      <p style="color:red; font-size:1.3rem;">
        O jogador ${jogadorDois.nome}, <strong>marcou</strong> pontos nesta rodada.
      </p>
      `
    }
  `;
}

  if (state.tela === "ranking") {
    const r = [...state.jogadores].sort((a,b)=> a.pontos - b.pontos);
    box.innerHTML = `<h2>RANKING FINAL</h2>` + r.map((j,i)=>`<div>${i+1}¬∫ ${j.nome}: ${j.pontos}</div>`).join("") +
      `<button onclick="location.reload()" style="margin-top:20px">SAIR DO JOGO</button>`;
  }
}

/* ================= A√á√ïES DO JOGO ================= */

function registrar() {
  const n = document.getElementById("nInp").value.trim();
  if (!n) return;

  state.meuNome = n;
  state.tela = "escolha-sala";
  render();
}

function finalizarRegistro(nome) {
  state.meuNome = nome;
  state.tela = "escolha-sala";
  render();
}

function iniciarJogo() {
  const perguntaSorteada = bancoPerguntasOriginal[Math.floor(Math.random() * bancoPerguntasOriginal.length)];
  salvarEstadoGlobal({
    tela: "jogo",
    pergunta: perguntaSorteada,
    jogadorDaVez: state.jogadores[0],
    valorAtual: null,
    ultimoJogador: null
  });
}

function enviarPalpite() {
  const v = Number(document.getElementById("chInp").value);
  if (state.valorAtual && v <= state.valorAtual) return alert("O valor deve ser MAIOR que o anterior!");
  
  const idx = state.jogadores.findIndex(j => j.nome === state.jogadorDaVez.nome);
  const proximo = state.jogadores[(idx + 1) % state.jogadores.length];
  
  salvarEstadoGlobal({
    valorAtual: v,
    ultimoJogador: state.jogadorDaVez,
    jogadorDaVez: proximo
  });
}

async function duvidar() {

  const correta = state.pergunta.resposta;
  let novosJogadores = [...state.jogadores];

  const jogadorUm = state.ultimoJogador;
  const jogadorDois = state.jogadorDaVez;

  let resultadoTexto = "";
  let jogadorUmPontuou = false;

   tocarSom("som-duvida", 0.6);
   await delay(2000);

  if (state.valorAtual > correta) {
    // JogadorUm mentiu
    tocarSom("som-ponto", 0.6);
    const jIdx = novosJogadores.findIndex(j => j.nome === jogadorUm.nome);
    novosJogadores[jIdx].pontos++;
    jogadorUmPontuou = true;
  } else {
    // JogadorDois errou a d√∫vida
    tocarSom("som-erro", 0.6);
    const dIdx = novosJogadores.findIndex(j => j.nome === jogadorDois.nome);
    novosJogadores[dIdx].pontos++;
  }

  // üî• Atualiza estado para tela de resultado
  salvarEstadoGlobal({
    jogadores: novosJogadores,
    tela: "resultado-duvida",
    respostaOficial: correta,
    jogadorUm: jogadorUm,
    jogadorDois: jogadorDois,
    jogadorUmPontuou: jogadorUmPontuou
  });

  // üî• Ap√≥s tempo configurado ‚Üí pr√≥xima pergunta
  setTimeout(() => {

    const novaPergunta = bancoPerguntasOriginal[Math.floor(Math.random() * bancoPerguntasOriginal.length)];

    salvarEstadoGlobal({
      tela: "jogo",
      pergunta: novaPergunta,
      valorAtual: null,
      ultimoJogador: null,
      respostaOficial: null,
      jogadorUm: null,
      jogadorDois: null,
      jogadorUmPontuou: null
    });

  }, TEMPO_RESULTADO_DUVIDA);
}

function enviarMensagemChat(texto) {
  if (!state.salaId) return;
  db.ref(`salas/${state.salaId}/chat`).push({
    autor: `<strong>${state.meuNome}</strong>`,
    texto: texto
  });
}

function exibirNoChat(autor, texto) {
  const box = document.getElementById("chat-messages");
  if(!box) return;
  box.innerHTML += `<div>${autor}: ${texto}</div>`;
  box.scrollTop = box.scrollHeight;
}

function salvarEstadoGlobal(novoEstado) {
  if (state.salaId) {
    db.ref(`salas/${state.salaId}/estado`).update(novoEstado);
  }
}

function tocarSom(id, volume = 0.5) {
  const som = document.getElementById(id);
  if (!som) return;
  som.volume = volume;
  som.currentTime = 0; // Reinicia se j√° estiver tocando
  som.play();
}

render();

document.addEventListener("click", function(e) {
  if (e.target.tagName === "BUTTON") {
    tocarSom("som-clique", 0.3);
  }
});

function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();

  reader.onload = function(e) {
    state.meuAvatar = e.target.result;
  };

  reader.readAsDataURL(file);
}

//DESENHO DE AVATAR

let desenhando = false;
let canvas = null;
let ctx = null;

function abrirDesenho() {
  const modal = document.getElementById("modal-desenho");
  modal.style.display = "flex";

  canvas = document.getElementById("canvas-avatar");
  ctx = canvas.getContext("2d");

  ativarEventosCanvas();
}

function ativarEventosCanvas() {
  canvas.onmousedown = (e) => {
    desenhando = true;

    const rect = canvas.getBoundingClientRect();
    ctx.beginPath();
    ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
  };

  canvas.onmouseup = () => desenhando = false;
  canvas.onmouseleave = () => desenhando = false;

  canvas.onmousemove = (e) => {
    if (!desenhando) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    const cor = document.getElementById("cor-pincel").value;

    ctx.lineWidth = 4;
    ctx.lineCap = "round";
    ctx.strokeStyle = cor;

    ctx.lineTo(x, y);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
  };

}

function salvarDesenho() {
  // Criar um canvas tempor√°rio
  const canvasTemp = document.createElement("canvas");
  canvasTemp.width = canvas.width;
  canvasTemp.height = canvas.height;

  const ctxTemp = canvasTemp.getContext("2d");

  // Fundo branco
  ctxTemp.fillStyle = "#ffffff";
  ctxTemp.fillRect(0, 0, canvasTemp.width, canvasTemp.height);

  // Desenho por cima
  ctxTemp.drawImage(canvas, 0, 0);

  ctxTemp.beginPath();
  ctxTemp.arc(150, 150, 150, 0, Math.PI * 2);
  ctxTemp.clip();

  // Salva como imagem com fundo branco
  avatarTemp = canvasTemp.toDataURL("image/png");
  state.meuAvatar = avatarTemp;

  fecharDesenho();
}

function limparCanvas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
}

function fecharDesenho() { 
  document.getElementById("modal-desenho").style.display = "none"; 
}

function sairDaSala() {
  if (!state.salaId) return;

  const estadoRef = db.ref(`salas/${state.salaId}/estado`);

  estadoRef.once('value', (snap) => {
    const data = snap.val();
    if (!data || !data.jogadores) return;

    let jogadores = [...data.jogadores];
    const indexSaindo = jogadores.findIndex(j => j.id === minhaConexaoId);  

    if (indexSaindo === -1) return;

    const jogadorSaindo = jogadores[indexSaindo];
    jogadores.splice(indexSaindo, 1);

    // üî• Se n√£o sobrou ningu√©m ‚Üí apaga sala
    if (jogadores.length === 0) {
      db.ref(`salas/${state.salaId}`).remove();
      limparLocal();
      return;
    }

    let novoEstado = { jogadores };

    // üî• Se s√≥ sobrou 1 jogador ‚Üí volta para espera
    if (jogadores.length === 1) {
      novoEstado.tela = "espera";
      novoEstado.valorAtual = null;
      novoEstado.ultimoJogador = null;
      novoEstado.jogadorDaVez = jogadores[0];
    }

    // üî• Se estava no jogo
    if (data.tela === "jogo") {

      // üëâ Se quem saiu era o jogador da vez
      if (data.jogadorDaVez?.nome === jogadorSaindo.nome) {
        const proxIndex = indexSaindo % jogadores.length;
        novoEstado.jogadorDaVez = jogadores[proxIndex];
      }

      // üëâ Se quem saiu era o √∫ltimo que deu palpite
      if (data.ultimoJogador?.nome === jogadorSaindo.nome) {
        novoEstado.ultimoJogador = null;
        novoEstado.valorAtual = null;
      }
    }

    estadoRef.update(novoEstado);

    limparLocal();
  });
}

function limparLocal() {
  if (!state.salaId) return;

  db.ref(`salas/${state.salaId}/estado`).off();
  db.ref(`salas/${state.salaId}/chat`).off();

  state.salaId = null;
  state.jogadores = [];
  state.tela = "inicial";
  state.jogadorDaVez = null;
  state.ultimoJogador = null;
  state.valorAtual = null;

  render();
}

/* ================= TELA DE ABERTURA ================= */

window.addEventListener("load", () => {
  const video = document.getElementById("video-abertura");

  video.onended = () => {
    document.getElementById("tela-abertura").style.display = "none";
  };

  // Caso o autoplay seja bloqueado
  video.play().catch(() => {
    document.addEventListener("click", () => {
      video.play();
    }, { once: true });
  });
});

</script>

<!-- EFEITOS SONOROS -->
<audio id="som-clique" src="sons/clique/old-western-pistol-shot-sound-effect/old-western-pistol-shot-sound-effect.mp3"></audio>
<audio id="som-duvida" src="sons/duvida/what-did-you-say-sound-effect.mp3"></audio>
<audio id="som-ponto" src="sons/ponto/epic-musical-finale-sound-effect.mp3"></audio>
<audio id="som-erro" src="sons/erro.mp3"></audio>

<audio id="bg-music" loop>
  <source src="sons/ambiente.mp3" type="audio/mpeg">
</audio>

<button id="music-btn" onclick="toggleMusic()" 
  style="position: fixed; bottom: 20px; right: 20px; width: 100px; z-index: 200;">
  üéµ M√öSICA
</button>

<div id="modal-desenho" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  justify-content:center;
  align-items:center;
  flex-direction:column;
  gap:10px;
">

  <div style="display:flex; gap:10px; align-items:center;">
    <label style="font-weight:bold;">COR:</label>
    <input type="color" id="cor-pincel" value="#000000">
  </div>

  <canvas id="canvas-avatar" width="300" height="300"
    style="background:white; border-radius:10px;"></canvas>

  <div style="display:flex; gap:10px;">
    <button onclick="salvarDesenho()">SALVAR</button>
    <button onclick="limparCanvas()">LIMPAR</button>
    <button onclick="fecharDesenho()">FECHAR</button>
  </div>
</div>

</body>

</html>
